#!/bin/bash
# Complete Penetration Test Workflow
# Orchestrates all NOX tools for a full security assessment

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TARGET_DOMAIN=${1:-"example.com"}
OUTPUT_DIR="./pentest_results_$(date +%s)"
WORDLIST="${2:-wordlists/subdomains.txt}"

# Banner
echo -e "${BLUE}╔════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  NOX FRAMEWORK - AUTOMATED PENETRATION TEST            ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${YELLOW}[*] Target: ${TARGET_DOMAIN}${NC}"
echo -e "${YELLOW}[*] Output Directory: ${OUTPUT_DIR}${NC}"
echo -e "${YELLOW}[*] Wordlist: ${WORDLIST}${NC}"
echo ""

# Create output directory
mkdir -p "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR/logs"

# ============================================================================
# PHASE 1: RECONNAISSANCE
# ============================================================================
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}[1/5] RECONNAISSANCE & DISCOVERY${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo ""

echo -e "${YELLOW}[*] Starting subdomain enumeration...${NC}"
python3 nox recon subx \
  --domain "$TARGET_DOMAIN" \
  --wordlist "$WORDLIST" \
  --passive \
  --confirm-legal \
  --output json \
  --out-file "$OUTPUT_DIR/subdomains.json" 2>&1 | tee "$OUTPUT_DIR/logs/recon.log"

echo -e "${GREEN}[+] Subdomains enumerated${NC}\n"

# Extract unique IPs from subdomain results
TARGETS=$(jq -r '.subdomains[0:3]' "$OUTPUT_DIR/subdomains.json" 2>/dev/null || echo "localhost")

# ============================================================================
# PHASE 2: VULNERABILITY SCANNING
# ============================================================================
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}[2/5] VULNERABILITY SCANNING${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo ""

SCAN_COUNT=0
for target in $(echo "$TARGETS" | tr ',' '\n' | head -3); do
  if [ -z "$target" ] || [ "$target" = "localhost" ]; then
    continue
  fi
  
  SCAN_COUNT=$((SCAN_COUNT + 1))
  echo -e "${YELLOW}[*] Scanning target $SCAN_COUNT: $target${NC}"
  
  python3 nox vuln scanx \
    --target "$target" \
    --scan-type standard \
    --vuln-check \
    --confirm-legal \
    --output json \
    --out-file "$OUTPUT_DIR/scan_${SCAN_COUNT}.json" 2>&1 | tee -a "$OUTPUT_DIR/logs/scanning.log"
  
  echo -e "${GREEN}[+] Completed scan $SCAN_COUNT${NC}\n"
done

if [ $SCAN_COUNT -eq 0 ]; then
  echo -e "${YELLOW}[!] No targets scanned (use real target domain)${NC}\n"
fi

# ============================================================================
# PHASE 3: EXPLOITATION TESTING
# ============================================================================
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}[3/5] EXPLOITATION TESTING${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo ""

echo -e "${YELLOW}[*] Testing for SQL injection vulnerabilities...${NC}"
python3 nox webpwn sqlix \
  --url "http://${TARGET_DOMAIN}/app.php?id=" \
  --method GET \
  --enum-dbs \
  --confirm-legal \
  --output json \
  --out-file "$OUTPUT_DIR/sqli_results.json" 2>&1 | tee "$OUTPUT_DIR/logs/exploitation.log"

echo -e "${GREEN}[+] Exploitation testing complete${NC}\n"

# ============================================================================
# PHASE 4: CUSTOM ANALYSIS
# ============================================================================
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}[4/5] CUSTOM ANALYSIS & PROCESSING${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo ""

# Run custom vulnerability analysis if script exists
if [ -f "scripts/analyze_vulnerabilities.py" ]; then
  echo -e "${YELLOW}[*] Running custom vulnerability analysis...${NC}"
  for scan_file in "$OUTPUT_DIR"/scan_*.json; do
    if [ -f "$scan_file" ]; then
      python3 scripts/analyze_vulnerabilities.py --input "$scan_file" --generate-report
    fi
  done
  echo -e "${GREEN}[+] Analysis complete${NC}\n"
fi

# ============================================================================
# PHASE 5: REPORTING
# ============================================================================
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}[5/5] REPORT GENERATION${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo ""

# Use first scan file for report if it exists
if [ -f "$OUTPUT_DIR/scan_1.json" ]; then
  echo -e "${YELLOW}[*] Generating comprehensive report...${NC}"
  python3 nox report renderx \
    --findings "$OUTPUT_DIR/scan_1.json" \
    --template technical \
    --title "Penetration Test Report - ${TARGET_DOMAIN}" \
    --client "Security Team" \
    --date "$(date +%Y-%m-%d)" \
    --include-evidence \
    --include-remediation \
    --format pdf \
    --out-file "$OUTPUT_DIR/pentest_report_${TARGET_DOMAIN}.pdf" \
    --confirm-legal 2>&1 | tee "$OUTPUT_DIR/logs/reporting.log"
  
  echo -e "${GREEN}[+] Report generated${NC}\n"
else
  echo -e "${YELLOW}[!] Skipping report generation (no scan results)${NC}\n"
fi

# ============================================================================
# SUMMARY
# ============================================================================
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}✅ PENETRATION TEST COMPLETE${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${GREEN}Results Location:${NC} ${OUTPUT_DIR}/"
echo ""
echo -e "${GREEN}Generated Files:${NC}"
ls -lh "$OUTPUT_DIR" | grep -E "\.json|\.pdf" | awk '{print "  " $9 " (" $5 ")"}'
echo ""
echo -e "${GREEN}Logs:${NC}"
ls -lh "$OUTPUT_DIR/logs" | tail -n +2 | awk '{print "  " $9 " (" $5 ")"}'
echo ""
echo -e "${YELLOW}Next Steps:${NC}"
echo "  1. Review the report: $OUTPUT_DIR/pentest_report_${TARGET_DOMAIN}.pdf"
echo "  2. Analyze vulnerabilities: $OUTPUT_DIR/scan_*.json"
echo "  3. Check logs: $OUTPUT_DIR/logs/"
echo ""
